name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update formula file
        run: |
          FORMULA="${{ github.event.client_payload.formula }}"
          VERSION="${{ github.event.client_payload.version }}"
          SHA_ARM="${{ github.event.client_payload.sha_arm }}"
          SHA_INTEL="${{ github.event.client_payload.sha_intel }}"

          if [ "$FORMULA" = "devcap" ]; then
            cat > Formula/devcap.rb <<'RUBY'
          class Devcap < Formula
            desc "Aggregate git commits across repos for standups and time tracking"
            homepage "https://github.com/konradmichalik/devcap"
            version "__VERSION__"
            license "MIT"

            on_arm do
              url "https://github.com/konradmichalik/devcap/releases/download/v#{version}/devcap-arm64-apple-darwin.tar.gz"
              sha256 "__SHA_ARM__"
            end

            on_intel do
              url "https://github.com/konradmichalik/devcap/releases/download/v#{version}/devcap-x86_64-apple-darwin.tar.gz"
              sha256 "__SHA_INTEL__"
            end

            def install
              bin.install "devcap"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/devcap --version")
            end
          end
          RUBY
            sed -i "s/__VERSION__/${VERSION}/g; s/__SHA_ARM__/${SHA_ARM}/g; s/__SHA_INTEL__/${SHA_INTEL}/g" Formula/devcap.rb

          else
            echo "Unknown formula: ${FORMULA}"
            exit 1
          fi

      - name: Commit and push
        run: |
          FORMULA="${{ github.event.client_payload.formula }}"
          VERSION="${{ github.event.client_payload.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "chore: update ${FORMULA} to v${VERSION}"
          git push
